<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ContextNote | My Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #f6f7f9;
        --surface: #ffffff;
        --border: #e4e7ec;
        --border-strong: #d0d5dd;
        --ink: #101828;
        --ink-2: #344054;
        --muted: #667085;
        --muted-2: #98a2b3;
        --accent: #4f46e5;
        --accent-bg: #eef2ff;
        --active-nav: #eef2ff;
        --highlight-bg: #fffbeb;
        --highlight-border: #f59e0b;
        --radius: 12px;
        --nav-width: 260px;
        --topbar-h: 60px;
      }

      *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: var(--bg);
        color: var(--ink);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
      .topbar {
        height: var(--topbar-h);
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        flex-shrink: 0;
        z-index: 100;
        padding-right: 20px;
      }

      .topbar-logo {
        width: var(--nav-width);
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 16px;
        flex-shrink: 0;
        border-right: 1px solid var(--border);
        height: 100%;
        transition: width 0.3s cubic-bezier(0.16,1,0.3,1);
      }

      /* hamburger */
      .hamburger {
        width: 34px; height: 34px;
        border-radius: 8px;
        border: 1.5px solid var(--border);
        background: transparent;
        cursor: pointer;
        display: grid;
        place-items: center;
        flex-shrink: 0;
        transition: background 0.15s, border-color 0.15s;
      }
      .hamburger:hover { background: var(--accent-bg); border-color: var(--accent); }

      .hicon { display: flex; flex-direction: column; gap: 4px; }
      .hicon span {
        display: block; height: 2px; border-radius: 2px;
        background: var(--ink-2);
        transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        transform-origin: center;
      }
      .hicon span:nth-child(1) { width: 16px; }
      .hicon span:nth-child(2) { width: 11px; }
      .hicon span:nth-child(3) { width: 14px; }

      /* X state */
      .hamburger.is-open .hicon span:nth-child(1) { width: 16px; transform: translateY(6px) rotate(45deg); }
      .hamburger.is-open .hicon span:nth-child(2) { opacity: 0; transform: scaleX(0); }
      .hamburger.is-open .hicon span:nth-child(3) { width: 16px; transform: translateY(-6px) rotate(-45deg); }

      .logo-icon {
        width: 32px; height: 32px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        border-radius: 8px;
        display: grid; place-items: center;
        flex-shrink: 0;
      }
      .logo-icon svg { width: 17px; height: 17px; fill: white; }

      .logo-name { font-size: 15px; font-weight: 700; color: var(--ink); letter-spacing: -0.3px; white-space: nowrap; }
      .logo-name span { color: var(--accent); }

      /* search */
      .search-wrap { flex: 1; padding: 0 20px; display: flex; align-items: center; }
      .search-box { width: 100%; max-width: 480px; position: relative; }
      .search-box .s-icon {
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        width: 15px; height: 15px;
        stroke: var(--muted-2); fill: none; stroke-width: 2;
        stroke-linecap: round; stroke-linejoin: round;
        pointer-events: none;
      }
      .search-box input {
        width: 100%; height: 37px;
        padding: 0 14px 0 38px;
        border: 1.5px solid var(--border); border-radius: 9px;
        font-family: inherit; font-size: 13.5px;
        color: var(--ink); background: var(--bg); outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .search-box input::placeholder { color: var(--muted-2); }
      .search-box input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
        background: #fff;
      }

      /* clear search btn */
      .search-clear {
        position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        display: none; background: none; border: none; cursor: pointer;
        color: var(--muted-2); font-size: 16px; line-height: 1;
        padding: 2px 4px;
      }
      .search-clear:hover { color: var(--ink); }
      .search-clear.visible { display: block; }

      /* ‚îÄ‚îÄ APP BODY ‚îÄ‚îÄ */
      .app-body { display: flex; flex: 1; overflow: hidden; position: relative; }

      /* overlay */
      .sidebar-overlay {
        display: none;
        position: fixed; inset: 0; top: var(--topbar-h);
        background: rgba(16,24,40,0.3);
        z-index: 80;
        backdrop-filter: blur(2px);
        animation: fadein 0.2s ease;
      }
      .sidebar-overlay.visible { display: block; }
      @keyframes fadein { from { opacity:0 } to { opacity:1 } }

      /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
      .sidebar {
        width: var(--nav-width);
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex; flex-direction: column;
        flex-shrink: 0; overflow: hidden;
        transition: width 0.3s cubic-bezier(0.16,1,0.3,1),
                    border-color 0.3s;
        z-index: 90;
      }
      .sidebar.collapsed { width: 0; border-right-color: transparent; }

      .sidebar-header { padding: 14px 14px 8px; flex-shrink: 0; }
      .sidebar-label {
        font-size: 10.5px; font-weight: 600; color: var(--muted-2);
        text-transform: uppercase; letter-spacing: 0.09em;
        padding: 0 8px; margin-bottom: 6px; display: block;
      }
      .sidebar-meta {
        font-size: 11.5px; color: var(--muted);
        padding: 0 8px 10px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 4px;
      }

      .sidebar-scroll { flex: 1; overflow-y: auto; padding: 4px 8px 20px; }
      .sidebar-scroll::-webkit-scrollbar { width: 3px; }
      .sidebar-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

      .nav-item {
        display: flex; align-items: center; gap: 9px;
        padding: 8px 10px; border-radius: 8px;
        cursor: pointer; margin-bottom: 1px;
        text-decoration: none;
        transition: background 0.15s;
        border: none; outline: none;
      }
      .nav-item:hover { background: var(--bg); }
      .nav-item.active { background: var(--active-nav); }
      .nav-item.active .nav-dot { background: var(--accent); }
      .nav-item.active .nav-domain { color: var(--accent); font-weight: 600; }
      .nav-item.active .nav-badge { background: var(--accent); color: #fff; border-color: var(--accent); }

      .nav-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--border-strong); flex-shrink: 0; transition: background 0.15s; }
      .nav-item:hover .nav-dot { background: var(--accent); }
      .nav-domain { font-size: 13px; font-weight: 500; color: var(--ink-2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .nav-badge {
        font-size: 10.5px; font-weight: 600; color: var(--muted);
        background: var(--bg); border: 1px solid var(--border);
        border-radius: 20px; padding: 1px 7px; flex-shrink: 0;
        transition: background 0.15s, color 0.15s, border-color 0.15s;
      }

      /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
      .main { flex: 1; overflow-y: auto; padding: 28px 32px; }
      .main::-webkit-scrollbar { width: 4px; }
      .main::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

      .main-heading { font-size: 21px; font-weight: 700; color: var(--ink); letter-spacing: -0.3px; margin-bottom: 3px; }
      .main-sub { font-size: 13px; color: var(--muted); margin-bottom: 28px; }
      .main-sub strong { color: var(--ink-2); }

      /* no results */
      .no-results { display: none; text-align: center; padding: 60px 20px; color: var(--muted); }
      .no-results.show { display: block; }
      .no-results h3 { font-size: 15px; color: var(--ink-2); margin-bottom: 6px; }

      /* site section */
      .site-section { margin-bottom: 40px; animation: fadeUp 0.4s ease both; }
      .site-section:nth-child(1) { animation-delay: 0.05s; }
      .site-section:nth-child(2) { animation-delay: 0.12s; }
      .site-section:nth-child(3) { animation-delay: 0.19s; }
      .site-section:nth-child(4) { animation-delay: 0.26s; }
      .site-section:nth-child(5) { animation-delay: 0.33s; }
      @keyframes fadeUp {
        from { opacity:0; transform:translateY(14px); }
        to   { opacity:1; transform:translateY(0); }
      }

      .section-head {
        display: flex; align-items: center; gap: 10px;
        margin-bottom: 14px;
      }
      .section-globe {
        width: 30px; height: 30px; border-radius: 8px;
        background: var(--accent-bg); display: grid; place-items: center; flex-shrink: 0;
      }
      .section-globe svg { width: 15px; height: 15px; stroke: var(--accent); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
      .section-domain { font-size: 14.5px; font-weight: 700; color: var(--ink); }
      .section-link {
        font-size: 11.5px; color: var(--muted); text-decoration: none;
        display: inline-flex; align-items: center; gap: 3px;
        transition: color 0.15s;
      }
      .section-link:hover { color: var(--accent); }
      .section-count {
        margin-left: auto;
        font-size: 11.5px; color: var(--muted);
        background: var(--bg); border: 1px solid var(--border);
        border-radius: 20px; padding: 2px 9px;
      }

      /* ‚îÄ‚îÄ NOTES ROW ‚îÄ‚îÄ */
      .notes-grid {
        display: flex; gap: 14px;
        overflow-x: auto; overflow-y: visible;
        padding-bottom: 10px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }
      .notes-grid::-webkit-scrollbar { height: 4px; }
      .notes-grid::-webkit-scrollbar-track { background: transparent; }
      .notes-grid::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }
      .notes-grid::-webkit-scrollbar-thumb:hover { background: var(--accent); }

      /* ‚îÄ‚îÄ NOTE CARD ‚îÄ‚îÄ */
      .note-card {
        background: var(--surface);
        border: 1.5px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
        min-width: 280px; max-width: 280px;
        display: flex; flex-direction: column; gap: 10px;
        flex-shrink: 0;
        scroll-snap-align: start;
        position: relative;
        transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
      }
      .note-card:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 18px rgba(79,70,229,0.1);
        transform: translateY(-2px);
      }

      /* card action buttons (edit / delete) */
      .card-actions {
        position: absolute; top: 12px; right: 12px;
        display: flex; gap: 4px;
        opacity: 0; pointer-events: none;
        transition: opacity 0.2s;
      }
      .note-card:hover .card-actions { opacity: 1; pointer-events: auto; }

      .action-btn {
        width: 26px; height: 26px; border-radius: 6px;
        border: 1px solid var(--border); background: var(--bg);
        display: grid; place-items: center;
        cursor: pointer; font-size: 13px; color: var(--muted);
        transition: all 0.15s;
      }
      .action-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-bg); }
      .action-btn.del:hover { border-color: #ef4444; color: #ef4444; background: #fff5f5; }

      .note-title {
        font-size: 13.5px; font-weight: 700; color: var(--ink);
        line-height: 1.4; padding-right: 60px;
      }

      .note-highlight-block {
        font-family: "Lora", serif; font-style: italic;
        font-size: 12px; color: #92400e;
        background: var(--highlight-bg);
        border-left: 3px solid var(--highlight-border);
        padding: 7px 10px; border-radius: 0 6px 6px 0;
        line-height: 1.55;
      }

      .note-body { font-size: 13px; color: var(--ink-2); line-height: 1.6; flex: 1; }

      .note-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: auto; }
      .tag {
        font-size: 10.5px; font-weight: 600;
        padding: 2px 9px; border-radius: 20px;
        background: var(--bg); color: var(--muted);
        border: 1px solid var(--border);
      }

      /* divider */
      .divider { height: 1px; background: var(--border); margin: 32px 0; }

      /* empty state */
      .empty-state {
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        gap: 10px; padding: 80px 40px; color: var(--muted);
        text-align: center;
      }
      .empty-icon { font-size: 40px; opacity: 0.3; }
      .empty-state h3 { font-size: 16px; color: var(--ink-2); font-weight: 600; }
      .empty-state p { font-size: 13px; }

      /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
      .modal-bg {
        display: none; position: fixed; inset: 0;
        background: rgba(16,24,40,0.45); z-index: 200;
        place-items: center;
        backdrop-filter: blur(3px);
        animation: fadein 0.2s ease;
      }
      .modal-bg.show { display: grid; }
      .modal {
        background: var(--surface); border-radius: 14px;
        padding: 28px; width: 90%; max-width: 440px;
        box-shadow: 0 20px 60px rgba(16,24,40,0.18);
        animation: slideUp 0.25s cubic-bezier(0.16,1,0.3,1);
      }
      @keyframes slideUp {
        from { opacity:0; transform:translateY(20px); }
        to   { opacity:1; transform:translateY(0); }
      }
      .modal h3 { font-size: 16px; font-weight: 700; color: var(--ink); margin-bottom: 14px; }
      .modal textarea {
        width: 100%; min-height: 100px; resize: vertical;
        border: 1.5px solid var(--border); border-radius: 9px;
        padding: 10px 12px; font-family: inherit; font-size: 13.5px;
        color: var(--ink); outline: none; line-height: 1.6;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .modal textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(79,70,229,0.12); }
      .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 14px; }
      .btn {
        padding: 8px 18px; border-radius: 8px; font-family: inherit;
        font-size: 13px; font-weight: 600; cursor: pointer;
        border: 1.5px solid var(--border); background: var(--bg);
        color: var(--ink-2); transition: all 0.15s;
      }
      .btn:hover { background: var(--border); }
      .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
      .btn.primary:hover { background: #4338ca; border-color: #4338ca; }

      /* toast */
      .toast {
        position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(10px);
        background: var(--ink); color: #fff;
        padding: 10px 20px; border-radius: 10px;
        font-size: 13px; font-weight: 500;
        opacity: 0; pointer-events: none;
        transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        z-index: 300;
        white-space: nowrap;
      }
      .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

      /* mobile */
      @media (max-width: 768px) {
        .sidebar {
          position: fixed; left: 0; top: var(--topbar-h); bottom: 0;
          z-index: 90;
          transform: translateX(0);
          width: var(--nav-width) !important;
          transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        .sidebar.collapsed { transform: translateX(-100%); border-right-color: var(--border) !important; }
        .main { padding: 20px 16px; }
      }
    </style>
  </head>
  <body>

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="topbar-logo">
        <button class="hamburger is-open" id="hamburgerBtn" aria-label="Toggle sidebar">
          <div class="hicon"><span></span><span></span><span></span></div>
        </button>
        <div class="logo-icon">
          <svg viewBox="0 0 20 20">
            <rect x="3" y="3" width="14" height="2.5" rx="1.25"/>
            <rect x="3" y="7.5" width="10" height="2.5" rx="1.25"/>
            <rect x="3" y="12" width="12" height="2.5" rx="1.25"/>
            <rect x="3" y="16.5" width="7" height="2.5" rx="1.25" opacity="0.6"/>
          </svg>
        </div>
        <span class="logo-name">Context<span>Note</span></span>
      </div>

      <div class="search-wrap">
        <div class="search-box">
          <svg class="s-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="searchInput" placeholder="Search notes‚Ä¶" autocomplete="off" />
          <button class="search-clear" id="searchClear" title="Clear search">√ó</button>
        </div>
      </div>
    </header>

    <!-- overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-body">

      <!-- SIDEBAR -->
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <span class="sidebar-label">Sources</span>
          <div class="sidebar-meta" id="sidebarMeta">‚Äî</div>
        </div>
        <div class="sidebar-scroll" id="sidebarNav">
          {% if websites %}
            {% for site in websites %}
            <a class="nav-item{% if loop.first %} active{% endif %}"
               href="#site-{{ loop.index }}"
               data-target="site-{{ loop.index }}">
              <div class="nav-dot"></div>
              <span class="nav-domain" title="{{ site.domain }}">{{ site.domain }}</span>
              <span class="nav-badge">{{ site.notes | length }}</span>
            </a>
            {% endfor %}
          {% else %}
            <p style="padding:12px;font-size:13px;color:var(--muted)">No sources yet.</p>
          {% endif %}
        </div>
      </nav>

      <!-- MAIN -->
      <main class="main" id="mainContent">
        {% if websites %}

          <div class="main-heading">Your Notes</div>
          <div class="main-sub"><strong id="noteCount">0</strong> notes found</div>

          <div class="no-results" id="noResults">
            <h3>No notes match "<span id="noResultsQuery"></span>"</h3>
            <p>Try a different search term.</p>
          </div>

          {% for site in websites %}
          <div class="site-section" id="site-{{ loop.index }}" data-domain="{{ site.domain }}">
            <div class="section-head">
              <div class="section-globe">
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
              </div>
              <span class="section-domain">{{ site.domain }}</span>
              <a href="{{ site.url }}" target="_blank" class="section-link" rel="noopener">
                <svg viewBox="0 0 24 24" style="width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                Visit page
              </a>
              <span class="section-count">{{ site.notes | length }} note{{ 's' if (site.notes | length) != 1 }}</span>
            </div>

            <div class="notes-grid">
              {% for note in site.notes %}
              <div class="note-card"
                   data-id="{{ note.id }}"
                   data-title="{{ note.content | lower }}">

                <!-- action buttons -->
                <div class="card-actions">
                  <button class="action-btn edit" title="Edit note"
                    onclick="openEdit({{ note.id }}, this.closest('.note-card').querySelector('.note-body').textContent.trim())">
                    <svg viewBox="0 0 24 24" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                  </button>
                  <button class="action-btn del" title="Delete note"
                    onclick="deleteNote({{ note.id }}, this.closest('.note-card'))">
                    <svg viewBox="0 0 24 24" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round">
                      <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                      <path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                    </svg>
                  </button>
                </div>

                <div class="note-title">{{ note.content | truncate(55) }}</div>

                {% if note.text_selection %}
                <div class="note-highlight-block">"{{ note.text_selection }}"</div>
                {% endif %}

                <div class="note-body">{{ note.content }}</div>

                <div class="note-tags">
                  <span class="tag">{{ site.domain | truncate(22, true, '‚Ä¶') }}</span>
                </div>
              </div>
              {% endfor %}
            </div>

            {% if not loop.last %}<div class="divider"></div>{% endif %}
          </div>
          {% endfor %}

        {% else %}
          <div class="empty-state">
            <div class="empty-icon">üìù</div>
            <h3>No notes yet</h3>
            <p>Use the ContextNote extension to save notes from any webpage.</p>
          </div>
        {% endif %}
      </main>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal-bg" id="editModal">
      <div class="modal">
        <h3>Edit Note</h3>
        <textarea id="editTextarea" rows="5" placeholder="Note content‚Ä¶"></textarea>
        <div class="modal-actions">
          <button class="btn" id="cancelEdit">Cancel</button>
          <button class="btn primary" id="saveEdit">Save changes</button>
        </div>
      </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <script>
      /* ‚îÄ‚îÄ‚îÄ refs ‚îÄ‚îÄ‚îÄ */
      const sidebar      = document.getElementById('sidebar');
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      const overlay      = document.getElementById('sidebarOverlay');
      const mainEl       = document.getElementById('mainContent');
      const searchInput  = document.getElementById('searchInput');
      const searchClear  = document.getElementById('searchClear');
      const noResults    = document.getElementById('noResults');
      const noResultsQ   = document.getElementById('noResultsQuery');
      const noteCountEl  = document.getElementById('noteCount');
      const sidebarMeta  = document.getElementById('sidebarMeta');
      const navItems     = document.querySelectorAll('.nav-item[data-target]');
      const sections     = document.querySelectorAll('.site-section');
      const toastEl      = document.getElementById('toast');
      const editModal    = document.getElementById('editModal');
      const editTextarea = document.getElementById('editTextarea');

      let editNoteId     = null;
      let toastTimer     = null;

      /* ‚îÄ‚îÄ‚îÄ counts ‚îÄ‚îÄ‚îÄ */
      const totalNotes = document.querySelectorAll('.note-card').length;
      if (noteCountEl) noteCountEl.textContent = totalNotes;
      if (sidebarMeta) sidebarMeta.textContent = sections.length + ' site' + (sections.length !== 1 ? 's' : '') + ' ¬∑ ' + totalNotes + ' notes';

      /* ‚îÄ‚îÄ‚îÄ toast ‚îÄ‚îÄ‚îÄ */
      function showToast(msg, duration = 2500) {
        toastEl.textContent = msg;
        toastEl.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => toastEl.classList.remove('show'), duration);
      }

      /* ‚îÄ‚îÄ‚îÄ hamburger ‚îÄ‚îÄ‚îÄ */
      function isMobile() { return window.innerWidth <= 768; }

      function openSidebar() {
        sidebar.classList.remove('collapsed');
        hamburgerBtn.classList.add('is-open');
        if (isMobile()) overlay.classList.add('visible');
      }

      function closeSidebar() {
        sidebar.classList.add('collapsed');
        hamburgerBtn.classList.remove('is-open');
        overlay.classList.remove('visible');
      }

      hamburgerBtn.addEventListener('click', () => {
        sidebar.classList.contains('collapsed') ? openSidebar() : closeSidebar();
      });

      overlay.addEventListener('click', closeSidebar);

      /* close sidebar on mobile when nav item clicked */
      navItems.forEach(item => {
        item.addEventListener('click', e => {
          e.preventDefault();
          const target = document.getElementById(item.dataset.target);
          if (target) mainEl.scrollTo({ top: target.offsetTop - 24, behavior: 'smooth' });
          navItems.forEach(n => n.classList.remove('active'));
          item.classList.add('active');
          if (isMobile()) closeSidebar();
        });
      });

      /* ‚îÄ‚îÄ‚îÄ active nav on scroll ‚îÄ‚îÄ‚îÄ */
      mainEl.addEventListener('scroll', () => {
        let current = '';
        sections.forEach(sec => {
          if (mainEl.scrollTop + 100 >= sec.offsetTop) current = sec.id;
        });
        if (current) {
          navItems.forEach(n => n.classList.toggle('active', n.dataset.target === current));
        }
      });

      /* ‚îÄ‚îÄ‚îÄ search ‚îÄ‚îÄ‚îÄ */
      function runSearch(q) {
        let visible = 0;
        sections.forEach(sec => {
          let secVisible = 0;
          sec.querySelectorAll('.note-card').forEach(card => {
            const match = !q || card.dataset.title.includes(q);
            card.style.display = match ? '' : 'none';
            if (match) secVisible++;
          });
          sec.style.display = secVisible > 0 ? '' : 'none';
          if (secVisible > 0) visible++;
        });

        const empty = visible === 0 && q.length > 0;
        noResults.classList.toggle('show', empty);
        if (noResultsQ) noResultsQ.textContent = q;

        /* update count */
        const shown = document.querySelectorAll('.note-card:not([style*="none"])').length;
        if (noteCountEl) noteCountEl.textContent = q ? shown : totalNotes;

        searchClear.classList.toggle('visible', q.length > 0);
      }

      searchInput.addEventListener('input', () => runSearch(searchInput.value.trim().toLowerCase()));

      searchClear.addEventListener('click', () => {
        searchInput.value = '';
        runSearch('');
        searchInput.focus();
      });

      /* ‚îÄ‚îÄ‚îÄ delete note ‚îÄ‚îÄ‚îÄ */
      async function deleteNote(id, cardEl) {
        if (!confirm('Delete this note?')) return;
        try {
          const res = await fetch(`/notes/${id}`, { method: 'DELETE' });
          if (res.ok) {
            cardEl.style.transition = 'opacity 0.3s, transform 0.3s';
            cardEl.style.opacity = '0';
            cardEl.style.transform = 'scale(0.92)';
            setTimeout(() => {
              cardEl.remove();
              showToast('Note deleted');
            }, 300);
          } else {
            showToast('Failed to delete note');
          }
        } catch (e) {
          showToast('Network error');
        }
      }

      /* ‚îÄ‚îÄ‚îÄ edit note ‚îÄ‚îÄ‚îÄ */
      function openEdit(id, content) {
        editNoteId = id;
        editTextarea.value = content;
        editModal.classList.add('show');
        setTimeout(() => editTextarea.focus(), 50);
      }

      function closeEdit() {
        editModal.classList.remove('show');
        editNoteId = null;
      }

      document.getElementById('cancelEdit').addEventListener('click', closeEdit);

      /* close modal on bg click */
      editModal.addEventListener('click', e => { if (e.target === editModal) closeEdit(); });

      /* close modal on Escape */
      document.addEventListener('keydown', e => { if (e.key === 'Escape' && editModal.classList.contains('show')) closeEdit(); });

      document.getElementById('saveEdit').addEventListener('click', async () => {
        const newContent = editTextarea.value.trim();
        if (!newContent) { showToast('Note cannot be empty'); return; }

        try {
          const res = await fetch(`/notes/${editNoteId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: newContent }),
          });

          if (res.ok) {
            /* update card in-place without reload */
            const card = document.querySelector(`.note-card[data-id="${editNoteId}"]`);
            if (card) {
              card.querySelector('.note-title').textContent = newContent.length > 55 ? newContent.slice(0, 55) + '‚Ä¶' : newContent;
              card.querySelector('.note-body').textContent  = newContent;
              card.dataset.title = newContent.toLowerCase();
            }
            closeEdit();
            showToast('Note updated ‚úì');
          } else {
            showToast('Failed to save changes');
          }
        } catch (e) {
          showToast('Network error');
        }
      });
    </script>
  </body>
</html>