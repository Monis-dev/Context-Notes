<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ContextNote | Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Lora:ital@1&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f6f7f9;
        --sur: #fff;
        --bdr: #e4e7ec;
        --bdrs: #d0d5dd;
        --ink: #101828;
        --ink2: #344054;
        --mut: #667085;
        --mut2: #98a2b3;
        --acc: #4f46e5;
        --acc-bg: #eef2ff;
        --hbg: #fffbeb;
        --hbdr: #f59e0b;
        --nav: 260px;
        --top: 60px;
      }
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: var(--bg);
        color: var(--ink);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* ‚îÄ‚îÄ topbar ‚îÄ‚îÄ */
      .topbar {
        height: var(--top);
        background: var(--sur);
        border-bottom: 1px solid var(--bdr);
        display: flex;
        align-items: center;
        flex-shrink: 0;
        z-index: 100;
        padding-right: 20px;
      }
      .tl {
        width: var(--nav);
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 16px;
        flex-shrink: 0;
        border-right: 1px solid var(--bdr);
        height: 100%;
      }
      .logo {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        border-radius: 8px;
        display: grid;
        place-items: center;
        flex-shrink: 0;
      }
      .logo svg {
        width: 17px;
        height: 17px;
        fill: #fff;
      }
      .lname {
        font-size: 15px;
        font-weight: 700;
        letter-spacing: -0.3px;
        white-space: nowrap;
      }
      .lname span {
        color: var(--acc);
      }

      /* hamburger */
      .hbtn {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        border: 1.5px solid var(--bdr);
        background: transparent;
        cursor: pointer;
        display: grid;
        place-items: center;
        flex-shrink: 0;
        transition:
          background 0.15s,
          border-color 0.15s;
      }
      .hbtn:hover {
        background: var(--acc-bg);
        border-color: var(--acc);
      }
      .hico {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .hico span {
        display: block;
        height: 2px;
        border-radius: 2px;
        background: var(--ink2);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: center;
      }
      .hico span:nth-child(1) {
        width: 16px;
      }
      .hico span:nth-child(2) {
        width: 11px;
      }
      .hico span:nth-child(3) {
        width: 14px;
      }
      .hbtn.open .hico span:nth-child(1) {
        transform: translateY(6px) rotate(45deg);
      }
      .hbtn.open .hico span:nth-child(2) {
        opacity: 0;
        transform: scaleX(0);
      }
      .hbtn.open .hico span:nth-child(3) {
        transform: translateY(-6px) rotate(-45deg);
      }

      /* search */
      .sw {
        flex: 1;
        padding: 0 20px;
        display: flex;
        align-items: center;
      }
      .sb {
        width: 100%;
        max-width: 480px;
        position: relative;
      }
      .sb svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 15px;
        height: 15px;
        stroke: var(--mut2);
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        pointer-events: none;
      }
      .sb input {
        width: 100%;
        height: 37px;
        padding: 0 32px 0 38px;
        border: 1.5px solid var(--bdr);
        border-radius: 9px;
        font-family: inherit;
        font-size: 13.5px;
        color: var(--ink);
        background: var(--bg);
        outline: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }
      .sb input::placeholder {
        color: var(--mut2);
      }
      .sb input:focus {
        border-color: var(--acc);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
        background: #fff;
      }
      .sc {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--mut2);
        font-size: 17px;
        line-height: 1;
        padding: 2px 4px;
      }
      .sc:hover {
        color: var(--ink);
      }
      .sc.on {
        display: block;
      }

      /* account/sync menu */
      .synw {
        position: relative;
        flex-shrink: 0;
      }
      .synbtn {
        background: var(--sur);
        border: 1.5px solid var(--bdr);
        border-radius: 8px;
        padding: 7px 13px;
        font-size: 13px;
        font-weight: 600;
        color: var(--ink2);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 7px;
        transition: all 0.2s;
        font-family: inherit;
      }
      .synbtn:hover {
        border-color: var(--acc);
        background: var(--acc-bg);
        color: var(--acc);
      }
      .synbtn svg {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .synmenu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: var(--sur);
        border: 1px solid var(--bdr);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        width: 220px;
        display: none;
        flex-direction: column;
        padding: 8px;
        z-index: 300;
        animation: fadeDown 0.18s ease;
      }
      @keyframes fadeDown {
        from {
          opacity: 0;
          transform: translateY(-6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .synmenu.on {
        display: flex;
      }
      #uStatus {
        font-size: 11px;
        color: var(--mut);
        padding: 4px 8px 6px;
      }
      .sdiv {
        height: 1px;
        background: var(--bdr);
        margin: 4px 0;
      }
      .sitem {
        padding: 9px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--ink);
        transition: background 0.12s;
      }
      .sitem:hover {
        background: var(--bg);
      }
      .sitem.danger {
        color: #ef4444;
      }
      .sitem.danger:hover {
        background: #fef2f2;
      }

      /* layout */
      .body {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
      }
      .ovl {
        display: none;
        position: fixed;
        inset: 0;
        top: var(--top);
        background: rgba(16, 24, 40, 0.3);
        z-index: 80;
        backdrop-filter: blur(2px);
      }
      .ovl.on {
        display: block;
      }

      /* sidebar */
      .side {
        width: var(--nav);
        background: var(--sur);
        border-right: 1px solid var(--bdr);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow: hidden;
        transition:
          width 0.3s cubic-bezier(0.16, 1, 0.3, 1),
          border-color 0.3s;
        z-index: 90;
      }
      .side.closed {
        width: 0;
        border-right-color: transparent;
      }
      .shd {
        padding: 14px 14px 8px;
        flex-shrink: 0;
      }
      .slbl {
        font-size: 10.5px;
        font-weight: 600;
        color: var(--mut2);
        text-transform: uppercase;
        letter-spacing: 0.09em;
        padding: 0 8px;
        margin-bottom: 6px;
        display: block;
      }
      .smeta {
        font-size: 11.5px;
        color: var(--mut);
        padding: 0 8px 10px;
        border-bottom: 1px solid var(--bdr);
        margin-bottom: 4px;
      }
      .sscroll {
        flex: 1;
        overflow-y: auto;
        padding: 4px 8px 20px;
      }
      .sscroll::-webkit-scrollbar {
        width: 3px;
      }
      .sscroll::-webkit-scrollbar-thumb {
        background: var(--bdr);
        border-radius: 3px;
      }
      .na {
        display: flex;
        align-items: center;
        gap: 9px;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 1px;
        text-decoration: none;
        transition: background 0.15s;
      }
      .na:hover {
        background: var(--bg);
      }
      .na.on {
        background: var(--acc-bg);
      }
      .na.on .dot {
        background: var(--acc);
      }
      .na.on .nd {
        color: var(--acc);
        font-weight: 600;
      }
      .na.on .bdg {
        background: var(--acc);
        color: #fff;
        border-color: var(--acc);
      }
      .dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--bdrs);
        flex-shrink: 0;
        transition: background 0.15s;
      }
      .na:hover .dot {
        background: var(--acc);
      }
      .nd {
        font-size: 13px;
        font-weight: 500;
        color: var(--ink2);
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .bdg {
        font-size: 10.5px;
        font-weight: 600;
        color: var(--mut);
        background: var(--bg);
        border: 1px solid var(--bdr);
        border-radius: 20px;
        padding: 1px 7px;
        flex-shrink: 0;
        transition: all 0.15s;
      }

      /* main */
      .main {
        flex: 1;
        overflow-y: auto;
        padding: 28px 32px;
      }
      .main::-webkit-scrollbar {
        width: 4px;
      }
      .main::-webkit-scrollbar-thumb {
        background: var(--bdr);
        border-radius: 4px;
      }
      .mh {
        font-size: 21px;
        font-weight: 700;
        letter-spacing: -0.3px;
        margin-bottom: 3px;
      }
      .ms {
        font-size: 13px;
        color: var(--mut);
        margin-bottom: 28px;
      }
      .ms strong {
        color: var(--ink2);
      }
      .nores {
        display: none;
        text-align: center;
        padding: 60px 20px;
        color: var(--mut);
      }
      .nores.on {
        display: block;
      }
      .nores h3 {
        font-size: 15px;
        color: var(--ink2);
        margin-bottom: 6px;
      }

      /* section */
      .sec {
        margin-bottom: 40px;
        animation: fadeUp 0.4s ease both;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(14px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .sech {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 14px;
      }
      .globe {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        background: var(--acc-bg);
        display: grid;
        place-items: center;
        flex-shrink: 0;
      }
      .globe svg {
        width: 15px;
        height: 15px;
        stroke: var(--acc);
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .sdom {
        font-size: 14.5px;
        font-weight: 700;
      }
      .slink {
        font-size: 11.5px;
        color: var(--mut);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        transition: color 0.15s;
      }
      .slink:hover {
        color: var(--acc);
      }
      .scnt {
        margin-left: auto;
        font-size: 11.5px;
        color: var(--mut);
        background: var(--bg);
        border: 1px solid var(--bdr);
        border-radius: 20px;
        padding: 2px 9px;
      }

      /* grid */
      .grid {
        display: flex;
        gap: 14px;
        overflow-x: auto;
        overflow-y: visible;
        padding-bottom: 10px;
      }
      .grid::-webkit-scrollbar {
        height: 4px;
      }
      .grid::-webkit-scrollbar-thumb {
        background: var(--bdrs);
        border-radius: 4px;
      }
      .grid::-webkit-scrollbar-thumb:hover {
        background: var(--acc);
      }

      /* card */
      .card {
        background: var(--sur);
        border: 1.5px solid var(--bdr);
        border-radius: 12px;
        padding: 16px;
        min-width: 280px;
        max-width: 280px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-shrink: 0;
        position: relative;
        transition:
          border-color 0.2s,
          box-shadow 0.2s,
          transform 0.2s;
      }
      .card:hover {
        border-color: var(--acc);
        box-shadow: 0 4px 18px rgba(79, 70, 229, 0.1);
        transform: translateY(-2px);
      }
      .ca {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 4px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .card:hover .ca {
        opacity: 1;
        pointer-events: auto;
      }
      .act {
        width: 26px;
        height: 26px;
        border-radius: 6px;
        border: 1px solid var(--bdr);
        background: var(--bg);
        display: grid;
        place-items: center;
        cursor: pointer;
        color: var(--mut);
        transition: all 0.15s;
      }
      .act:hover {
        border-color: var(--acc);
        color: var(--acc);
        background: var(--acc-bg);
      }
      .act.del:hover {
        border-color: #ef4444;
        color: #ef4444;
        background: #fff5f5;
      }
      .ct {
        font-size: 14px;
        font-weight: 700;
        line-height: 1.4;
        padding-right: 60px;
        color: var(--ink);
      }
      .chi {
        font-family: "Lora", serif;
        font-style: italic;
        font-size: 12px;
        color: #92400e;
        background: var(--hbg);
        border-left: 3px solid var(--hbdr);
        padding: 7px 10px;
        border-radius: 0 6px 6px 0;
        line-height: 1.55;
        margin-bottom: 2px;
      }
      .cb {
        font-size: 13px;
        color: var(--ink2);
        line-height: 1.6;
        flex: 1;
      }
      .ctags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: auto;
      }
      .tag {
        font-size: 10.5px;
        font-weight: 600;
        padding: 2px 9px;
        border-radius: 20px;
        background: var(--bg);
        color: var(--mut);
        border: 1px solid var(--bdr);
      }
      .divider {
        height: 1px;
        background: var(--bdr);
        margin: 32px 0;
      }

      /* skeleton */
      .sk {
        background: var(--bdr);
        border-radius: 8px;
        animation: shim 1.2s infinite;
      }
      @keyframes shim {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.45;
        }
      }

      /* empty */
      .empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 80px 40px;
        color: var(--mut);
        text-align: center;
      }
      .empty span {
        font-size: 40px;
        opacity: 0.3;
      }
      .empty h3 {
        font-size: 16px;
        color: var(--ink2);
        font-weight: 600;
      }
      .empty p {
        font-size: 13px;
      }

      /* modal */
      .mbg {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(16, 24, 40, 0.45);
        z-index: 200;
        place-items: center;
        backdrop-filter: blur(3px);
      }
      .mbg.on {
        display: grid;
      }
      .modal {
        background: var(--sur);
        border-radius: 14px;
        padding: 28px;
        width: 90%;
        max-width: 440px;
        box-shadow: 0 20px 60px rgba(16, 24, 40, 0.18);
        animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .modal h3 {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 14px;
      }
      .modal input[type="text"] {
        width: 100%;
        border: 1.5px solid var(--bdr);
        border-radius: 9px;
        padding: 10px 12px;
        font-family: inherit;
        font-size: 14px;
        font-weight: 600;
        color: var(--ink);
        outline: none;
        margin-bottom: 12px;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }
      .modal input[type="text"]:focus {
        border-color: var(--acc);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
      }
      .modal textarea {
        width: 100%;
        min-height: 100px;
        resize: vertical;
        border: 1.5px solid var(--bdr);
        border-radius: 9px;
        padding: 10px 12px;
        font-family: inherit;
        font-size: 13.5px;
        color: var(--ink);
        outline: none;
        line-height: 1.6;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }
      .modal textarea:focus {
        border-color: var(--acc);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
      }
      .macts {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 14px;
      }
      .btn {
        padding: 8px 18px;
        border-radius: 8px;
        font-family: inherit;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1.5px solid var(--bdr);
        background: var(--bg);
        color: var(--ink2);
        transition: all 0.15s;
      }
      .btn:hover {
        background: var(--bdr);
      }
      .btn.pri {
        background: var(--acc);
        color: #fff;
        border-color: var(--acc);
      }
      .btn.pri:hover {
        background: #4338ca;
        border-color: #4338ca;
      }

      /* toast */
      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: var(--ink);
        color: #fff;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 500;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 400;
        white-space: nowrap;
      }
      .toast.on {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      @media (max-width: 768px) {
        .side {
          position: fixed;
          left: 0;
          top: var(--top);
          bottom: 0;
          z-index: 90;
          width: var(--nav) !important;
          transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .side.closed {
          transform: translateX(-100%);
          border-right-color: var(--bdr) !important;
        }
        .main {
          padding: 20px 16px;
        }
        .synbtn span {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="tl">
        <button class="hbtn open" id="hbtn" aria-label="Toggle sidebar">
          <div class="hico"><span></span><span></span><span></span></div>
        </button>
        <div class="logo">
          <svg viewBox="0 0 20 20">
            <rect x="3" y="3" width="14" height="2.5" rx="1.25" />
            <rect x="3" y="7.5" width="10" height="2.5" rx="1.25" />
            <rect x="3" y="12" width="12" height="2.5" rx="1.25" />
            <rect
              x="3"
              y="16.5"
              width="7"
              height="2.5"
              rx="1.25"
              opacity=".6"
            />
          </svg>
        </div>
        <span class="lname">Context<span>Note</span></span>
      </div>

      <div class="sw">
        <div class="sb">
          <svg viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input
            type="text"
            id="search"
            placeholder="Search notes‚Ä¶"
            autocomplete="off"
          />
          <button class="sc" id="sc">√ó</button>
        </div>
      </div>

      <!-- Account Button Replaced Cloud Sync -->
      <div class="synw">
        <button class="synbtn" id="synbtn">
          <svg
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span>Account</span>
        </button>

        <div class="synmenu" id="synmenu">
          <div id="uStatus">Checking auth‚Ä¶</div>
          <div class="sdiv"></div>
          <div class="sitem" onclick="location.href = '/login'">
            üîë Login with Google
          </div>
          <div class="sdiv"></div>
          <div class="sitem danger" onclick="location.href = '/logout'">
            üö™ Logout
          </div>
        </div>
      </div>
    </header>

    <div class="ovl" id="ovl"></div>

    <div class="body">
      <nav class="side" id="side">
        <div class="shd">
          <span class="slbl">Sources</span>
          <div class="smeta" id="smeta">Loading‚Ä¶</div>
        </div>
        <div class="sscroll" id="snav"></div>
      </nav>

      <main class="main" id="main">
        <div id="skel">
          <div
            class="sk"
            style="height: 26px; width: 160px; margin-bottom: 8px"
          ></div>
          <div
            class="sk"
            style="height: 16px; width: 100px; margin-bottom: 28px"
          ></div>
          <div style="margin-bottom: 36px">
            <div
              class="sk"
              style="height: 28px; width: 200px; margin-bottom: 14px"
            ></div>
            <div style="display: flex; gap: 14px">
              <div class="sk" style="min-width: 280px; height: 150px"></div>
              <div class="sk" style="min-width: 280px; height: 150px"></div>
              <div class="sk" style="min-width: 280px; height: 150px"></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div class="mbg" id="modal">
      <div class="modal">
        <h3>Edit Note</h3>
        <input type="text" id="etitle" placeholder="Heading..." />
        <textarea id="eta" rows="5" placeholder="Description..."></textarea>
        <div class="macts">
          <button class="btn" id="cancelEdit">Cancel</button>
          <button class="btn pri" id="saveEdit">Save</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const $ = (id) => document.getElementById(id);
      const E = (a, ev, fn) => a.addEventListener(ev, fn);
      const esc = (s) =>
        String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      let eId = null,
        tT = null,
        all = [];

      const toast = (m, ms = 2600) => {
        const t = $("toast");
        t.textContent = m;
        t.classList.add("on");
        clearTimeout(tT);
        tT = setTimeout(() => t.classList.remove("on"), ms);
      };

      const mob = () => window.innerWidth <= 768;
      const openS = () => {
        $("side").classList.remove("closed");
        $("hbtn").classList.add("open");
        if (mob()) $("ovl").classList.add("on");
      };
      const closeS = () => {
        $("side").classList.add("closed");
        $("hbtn").classList.remove("open");
        $("ovl").classList.remove("on");
      };
      E($("hbtn"), "click", () =>
        $("side").classList.contains("closed") ? openS() : closeS(),
      );
      E($("ovl"), "click", closeS);

      // account menu
      E($("synbtn"), "click", (e) => {
        e.stopPropagation();
        $("synmenu").classList.toggle("on");
      });
      E(document, "click", (e) => {
        if (!$("synmenu").contains(e.target) && e.target !== $("synbtn"))
          $("synmenu").classList.remove("on");
      });

      const card = (n, dom) => {
        const title = n.title || "Untitled";
        const body = n.content || "";
        const sel = n.selection || n.text_selection || "";
        const searchStr = (title + " " + body).toLowerCase();

        return `<div class="card" data-id="${n.id}" data-t="${esc(searchStr)}">
      <div class="ca">
        <button class="act" title="Edit" onclick="openEdit(${n.id}, this)">
          <svg viewBox="0 0 24 24" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="act del" title="Delete" onclick="del(${n.id},this.closest('.card'))">
          <svg viewBox="0 0 24 24" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        </button>
      </div>
      <div class="ct">${esc(title)}</div>
      ${sel ? `<div class="chi">"${esc(sel)}"</div>` : ""}
      ${body ? `<div class="cb">${esc(body)}</div>` : ""}
      <div class="ctags"><span class="tag">${esc(dom.slice(0, 22))}</span></div>
    </div>`;
      };

      function render(data) {
        $("skel")?.remove();
        const total = data.reduce((s, w) => s + w.notes.length, 0);
        $("smeta").textContent =
          `${data.length} site${data.length !== 1 ? "s" : ""} ¬∑ ${total} notes`;
        $("snav").innerHTML = data.length
          ? data
              .map(
                (s, i) =>
                  `<a class="na${i === 0 ? " on" : ""}" href="#s${i}" data-t="s${i}"><div class="dot"></div><span class="nd" title="${esc(s.domain)}">${esc(s.domain)}</span><span class="bdg">${s.notes.length}</span></a>`,
              )
              .join("")
          : '<p style="padding:12px;font-size:13px;color:var(--mut)">No sources yet.</p>';

        if (!data.length) {
          $("main").innerHTML =
            `<div class="empty"><span>üìù</span><h3>No notes yet</h3><p>Use the ContextNote extension to save notes from any webpage.</p></div>`;
          return;
        }

        $("main").innerHTML = `
      <div class="mh">Your Notes</div>
      <div class="ms"><strong id="nc">${total}</strong> notes found</div>
      <div class="nores" id="nores"><h3>No notes match "<span id="noresq"></span>"</h3><p>Try a different search term.</p></div>
      ${data
        .map(
          (site, i) => `
        <div class="sec" id="s${i}">
          <div class="sech">
            <div class="globe"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div>
            <span class="sdom">${esc(site.domain)}</span>
            <a href="${esc(site.url)}" target="_blank" rel="noopener" class="slink">
              <svg viewBox="0 0 24 24" style="width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
              Visit page
            </a>
            <span class="scnt">${site.notes.length} note${site.notes.length !== 1 ? "s" : ""}</span>
          </div>
          <div class="grid">${site.notes.map((n) => card(n, site.domain)).join("")}</div>
          ${i < data.length - 1 ? '<div class="divider"></div>' : ""}
        </div>`,
        )
        .join("")}`;

        bindNav();
        bindSearch();
      }

      function bindNav() {
        const nas = document.querySelectorAll(".na[data-t]"),
          secs = document.querySelectorAll(".sec");
        nas.forEach((a) =>
          E(a, "click", (e) => {
            e.preventDefault();
            $(a.dataset.t)?.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
            nas.forEach((n) => n.classList.remove("on"));
            a.classList.add("on");
            if (mob()) closeS();
          }),
        );
        E($("main"), "scroll", () => {
          let cur = "";
          secs.forEach((s) => {
            if ($("main").scrollTop + 100 >= s.offsetTop) cur = s.id;
          });
          if (cur)
            nas.forEach((a) => a.classList.toggle("on", a.dataset.t === cur));
        });
      }

      function bindSearch() {
        const inp = $("search"),
          clr = $("sc");
        E(inp, "input", run);
        E(clr, "click", () => {
          inp.value = "";
          run();
          inp.focus();
        });
      }

      function run() {
        const q = $("search").value.trim().toLowerCase();
        $("sc").classList.toggle("on", q.length > 0);
        let vis = 0;
        document.querySelectorAll(".sec").forEach((sec) => {
          const cards = [...sec.querySelectorAll(".card")];
          const matches = cards.filter(
            (c) => !q || (c.dataset.t || "").includes(q),
          );
          cards.forEach(
            (c) =>
              (c.style.display =
                !q || (c.dataset.t || "").includes(q) ? "" : "none"),
          );
          sec.style.display = matches.length > 0 ? "" : "none";
          vis += matches.length;
        });
        $("nores")?.classList.toggle("on", vis === 0 && q.length > 0);
        const qEl = $("noresq");
        if (qEl) qEl.textContent = q;
        const nc = $("nc");
        if (nc)
          nc.textContent = q
            ? vis
            : all.reduce((s, w) => s + w.notes.length, 0);
      }

      async function del(id, el) {
        if (!confirm("Delete this note?")) return;
        try {
          const r = await fetch(`/api/notes/${id}`, { method: "DELETE" });
          if (r.ok) {
            el.style.cssText =
              "transition:opacity .3s,transform .3s;opacity:0;transform:scale(.92)";
            setTimeout(() => {
              el.remove();
              toast("Note deleted");
            }, 300);
          } else toast("Failed to delete");
        } catch {
          toast("Network error");
        }
      }

      function openEdit(id, btnEl) {
        eId = id;
        const cardEl = btnEl.closest(".card");
        const titleEl = cardEl.querySelector(".ct");
        const descEl = cardEl.querySelector(".cb");
        $("etitle").value = titleEl ? titleEl.textContent.trim() : "";
        $("eta").value = descEl ? descEl.textContent.trim() : "";
        $("modal").classList.add("on");
        setTimeout(() => $("etitle").focus(), 50);
      }

      function closeEdit() {
        $("modal").classList.remove("on");
        eId = null;
      }
      E($("cancelEdit"), "click", closeEdit);
      E($("modal"), "click", (e) => {
        if (e.target === $("modal")) closeEdit();
      });
      E(document, "keydown", (e) => {
        if (e.key === "Escape" && $("modal").classList.contains("on"))
          closeEdit();
      });

      E($("saveEdit"), "click", async () => {
        const titleVal = $("etitle").value.trim() || "Untitled";
        const contentVal = $("eta").value.trim();
        if (!titleVal && !contentVal) {
          toast("Note cannot be completely empty");
          return;
        }
        try {
          const r = await fetch(`/api/notes/${eId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: titleVal, content: contentVal }),
          });
          if (r.ok) {
            const c = document.querySelector(`.card[data-id="${eId}"]`);
            if (c) {
              const ct = c.querySelector(".ct");
              if (ct) ct.textContent = titleVal;
              let cb = c.querySelector(".cb");
              if (contentVal) {
                if (!cb) {
                  cb = document.createElement("div");
                  cb.className = "cb";
                  c.insertBefore(cb, c.querySelector(".ctags"));
                }
                cb.textContent = contentVal;
              } else if (cb) {
                cb.remove();
              }
              c.dataset.t = (titleVal + " " + contentVal).toLowerCase();
            }
            closeEdit();
            toast("Note updated ‚úì");
          } else {
            toast("Failed to save");
          }
        } catch {
          toast("Network error");
        }
      });

      async function load() {
        try {
          const r = await fetch("/api/notes");
          if (r.status === 401) {
            // Unauthenticated user -> clear local data completely so they don't see old cached stuff
            $("uStatus").textContent = "Not signed in";
            return;
          }
          all = await r.json();
          render(all);
          fetch("/api/me")
            .then((r) => (r.ok ? r.json() : null))
            .then((d) => {
              if ($("uStatus"))
                $("uStatus").textContent = d
                  ? "‚úì Signed in as " + (d.email || d.name || "User")
                  : "Not signed in";
            })
            .catch(() => {});
        } catch {
          $("skel")?.remove();
          $("main").innerHTML =
            `<div class="empty"><span>‚ö†Ô∏è</span><h3>Could not load notes</h3><p>Make sure the server is running.</p></div>`;
        }
      }
      E(window, "load", load);
    </script>
  </body>
</html>
