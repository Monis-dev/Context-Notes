<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ContextNote | My Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Lora:ital@1&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f6f7f9;
        --surface: #fff;
        --border: #e4e7ec;
        --border-s: #d0d5dd;
        --ink: #101828;
        --ink2: #344054;
        --muted: #667085;
        --muted2: #98a2b3;
        --accent: #4f46e5;
        --accent-bg: #eef2ff;
        --hi-bg: #fffbeb;
        --hi-border: #f59e0b;
        --r: 12px;
        --nav: 260px;
        --top: 60px;
      }
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Plus Jakarta Sans", sans-serif;
        background: var(--bg);
        color: var(--ink);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* topbar */
      .topbar {
        height: var(--top);
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        flex-shrink: 0;
        z-index: 100;
        padding-right: 20px;
      }
      .topbar-logo {
        width: var(--nav);
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 16px;
        flex-shrink: 0;
        border-right: 1px solid var(--border);
        height: 100%;
      }
      .logo-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        border-radius: 8px;
        display: grid;
        place-items: center;
        flex-shrink: 0;
      }
      .logo-icon svg {
        width: 17px;
        height: 17px;
        fill: #fff;
      }
      .logo-name {
        font-size: 15px;
        font-weight: 700;
        letter-spacing: -0.3px;
        white-space: nowrap;
      }
      .logo-name span {
        color: var(--accent);
      }

      /* hamburger */
      .hbtn {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        flex-shrink: 0;
        transition:
          background 0.15s,
          border-color 0.15s;
      }
      .hbtn:hover {
        background: var(--accent-bg);
        border-color: var(--accent);
      }
      .hicon {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .hicon span {
        display: block;
        height: 2px;
        border-radius: 2px;
        background: var(--ink2);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: center;
      }
      .hicon span:nth-child(1) {
        width: 16px;
      }
      .hicon span:nth-child(2) {
        width: 11px;
      }
      .hicon span:nth-child(3) {
        width: 14px;
      }
      .hbtn.open .hicon span:nth-child(1) {
        transform: translateY(6px) rotate(45deg);
        width: 16px;
      }
      .hbtn.open .hicon span:nth-child(2) {
        opacity: 0;
        transform: scaleX(0);
      }
      .hbtn.open .hicon span:nth-child(3) {
        transform: translateY(-6px) rotate(-45deg);
        width: 16px;
      }

      /* search */
      .search-wrap {
        flex: 1;
        padding: 0 20px;
        display: flex;
        align-items: center;
      }
      .search-box {
        width: 100%;
        max-width: 480px;
        position: relative;
      }
      .search-box svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 15px;
        height: 15px;
        stroke: var(--muted2);
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        pointer-events: none;
      }
      .search-box input {
        width: 100%;
        height: 37px;
        padding: 0 32px 0 38px;
        border: 1.5px solid var(--border);
        border-radius: 9px;
        font-family: inherit;
        font-size: 13.5px;
        color: var(--ink);
        background: var(--bg);
        outline: none;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }
      .search-box input::placeholder {
        color: var(--muted2);
      }
      .search-box input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
        background: #fff;
      }
      .s-clear {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--muted2);
        font-size: 17px;
        line-height: 1;
        padding: 2px 4px;
      }
      .s-clear:hover {
        color: var(--ink);
      }
      .s-clear.on {
        display: block;
      }

      /* sync */
      .sync-wrap {
        position: relative;
        flex-shrink: 0;
      }
      .sync-btn {
        background: var(--surface);
        border: 1.5px solid var(--border);
        border-radius: 8px;
        padding: 7px 13px;
        font-size: 13px;
        font-weight: 600;
        color: var(--ink2);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 7px;
        transition: all 0.2s;
        font-family: inherit;
      }
      .sync-btn:hover {
        border-color: var(--accent);
        background: var(--accent-bg);
        color: var(--accent);
      }
      .sync-btn svg {
        width: 14px;
        height: 14px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .sync-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: var(--surface);
        border: 1px solid var(--border);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        width: 220px;
        display: none;
        flex-direction: column;
        padding: 8px;
        z-index: 300;
        animation: fadeDown 0.18s ease;
      }
      @keyframes fadeDown {
        from {
          opacity: 0;
          transform: translateY(-6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .sync-menu.on {
        display: flex;
      }
      #userStatus {
        font-size: 11px;
        color: var(--muted);
        padding: 4px 8px 6px;
      }
      .sync-div {
        height: 1px;
        background: var(--border);
        margin: 4px 0;
      }
      .sync-item {
        padding: 9px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--ink);
        transition: background 0.12s;
      }
      .sync-item:hover {
        background: var(--bg);
      }

      /* layout */
      .app-body {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
      }
      .overlay {
        display: none;
        position: fixed;
        inset: 0;
        top: var(--top);
        background: rgba(16, 24, 40, 0.3);
        z-index: 80;
        backdrop-filter: blur(2px);
      }
      .overlay.on {
        display: block;
      }

      /* sidebar */
      .sidebar {
        width: var(--nav);
        background: var(--surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow: hidden;
        transition:
          width 0.3s cubic-bezier(0.16, 1, 0.3, 1),
          border-color 0.3s;
        z-index: 90;
      }
      .sidebar.closed {
        width: 0;
        border-right-color: transparent;
      }
      .sidebar-hd {
        padding: 14px 14px 8px;
        flex-shrink: 0;
      }
      .sidebar-label {
        font-size: 10.5px;
        font-weight: 600;
        color: var(--muted2);
        text-transform: uppercase;
        letter-spacing: 0.09em;
        padding: 0 8px;
        margin-bottom: 6px;
        display: block;
      }
      .sidebar-meta {
        font-size: 11.5px;
        color: var(--muted);
        padding: 0 8px 10px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 4px;
      }
      .sidebar-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 4px 8px 20px;
      }
      .sidebar-scroll::-webkit-scrollbar {
        width: 3px;
      }
      .sidebar-scroll::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      .nav-a {
        display: flex;
        align-items: center;
        gap: 9px;
        padding: 8px 10px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 1px;
        text-decoration: none;
        transition: background 0.15s;
      }
      .nav-a:hover {
        background: var(--bg);
      }
      .nav-a.on {
        background: var(--accent-bg);
      }
      .nav-a.on .dot {
        background: var(--accent);
      }
      .nav-a.on .nav-d {
        color: var(--accent);
        font-weight: 600;
      }
      .nav-a.on .badge {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }
      .dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: var(--border-s);
        flex-shrink: 0;
        transition: background 0.15s;
      }
      .nav-a:hover .dot {
        background: var(--accent);
      }
      .nav-d {
        font-size: 13px;
        font-weight: 500;
        color: var(--ink2);
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .badge {
        font-size: 10.5px;
        font-weight: 600;
        color: var(--muted);
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 1px 7px;
        flex-shrink: 0;
        transition: all 0.15s;
      }

      /* main */
      .main {
        flex: 1;
        overflow-y: auto;
        padding: 28px 32px;
      }
      .main::-webkit-scrollbar {
        width: 4px;
      }
      .main::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }
      .main-h {
        font-size: 21px;
        font-weight: 700;
        letter-spacing: -0.3px;
        margin-bottom: 3px;
      }
      .main-s {
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 28px;
      }
      .main-s strong {
        color: var(--ink2);
      }
      .no-res {
        display: none;
        text-align: center;
        padding: 60px 20px;
        color: var(--muted);
      }
      .no-res.on {
        display: block;
      }
      .no-res h3 {
        font-size: 15px;
        color: var(--ink2);
        margin-bottom: 6px;
      }

      /* section */
      .section {
        margin-bottom: 40px;
        animation: fadeUp 0.4s ease both;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(14px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .sec-hd {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 14px;
      }
      .globe {
        background: var(--accent-bg);
        place-items: center;
        flex-shrink: 0;
      }
      .globe svg {
        width: 15px;
        height: 15px;
        stroke: var(--accent);
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .sec-domain {
        font-size: 14.5px;
        font-weight: 700;
      }
      .sec-link {
        font-size: 11.5px;
        color: var(--muted);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        transition: color 0.15s;
      }
      .sec-link:hover {
        color: var(--accent);
      }
      .sec-count {
        margin-left: auto;
        font-size: 11.5px;
        color: var(--muted);
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 2px 9px;
      }

      /* cards row */
      .grid {
        display: flex;
        gap: 14px;
        overflow-x: auto;
        overflow-y: visible;
        padding-bottom: 10px;
      }
      .grid::-webkit-scrollbar {
        height: 4px;
      }
      .grid::-webkit-scrollbar-thumb {
        background: var(--border-s);
        border-radius: 4px;
      }
      .grid::-webkit-scrollbar-thumb:hover {
        background: var(--accent);
      }

      /* card */
      .card {
        background: var(--surface);
        border: 1.5px solid var(--border);
        border-radius: var(--r);
        padding: 16px;
        min-width: 280px;
        max-width: 280px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-shrink: 0;
        position: relative;
        transition:
          border-color 0.2s,
          box-shadow 0.2s,
          transform 0.2s;
      }
      .card:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 18px rgba(79, 70, 229, 0.1);
        transform: translateY(-2px);
      }
      .card-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        display: flex;
        gap: 4px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .card:hover .card-actions {
        opacity: 1;
        pointer-events: auto;
      }
      .act {
        width: 26px;
        height: 26px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--bg);
        display: grid;
        place-items: center;
        cursor: pointer;
        color: var(--muted);
        transition: all 0.15s;
      }
      .act:hover {
        border-color: var(--accent);
        color: var(--accent);
        background: var(--accent-bg);
      }
      .act.del:hover {
        border-color: #ef4444;
        color: #ef4444;
        background: #fff5f5;
      }
      .c-title {
        font-size: 13.5px;
        font-weight: 700;
        line-height: 1.4;
        padding-right: 60px;
      }
      .c-hi {
        font-family: "Lora", serif;
        font-style: italic;
        font-size: 12px;
        color: #92400e;
        background: var(--hi-bg);
        border-left: 3px solid var(--hi-border);
        padding: 7px 10px;
        border-radius: 0 6px 6px 0;
        line-height: 1.55;
      }
      .c-body {
        font-size: 13px;
        color: var(--ink2);
        line-height: 1.6;
        flex: 1;
      }
      .c-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: auto;
      }
      .tag {
        font-size: 10.5px;
        font-weight: 600;
        padding: 2px 9px;
        border-radius: 20px;
        background: var(--bg);
        color: var(--muted);
        border: 1px solid var(--border);
      }
      .divider {
        height: 1px;
        background: var(--border);
        margin: 32px 0;
      }

      /* skeleton */
      .skel {
        background: var(--border);
        border-radius: 8px;
        animation: shimmer 1.2s infinite;
      }
      @keyframes shimmer {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.45;
        }
      }

      /* empty */
      .empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 80px 40px;
        color: var(--muted);
        text-align: center;
      }
      .empty-icon {
        font-size: 40px;
        opacity: 0.3;
      }
      .empty h3 {
        font-size: 16px;
        color: var(--ink2);
        font-weight: 600;
      }
      .empty p {
        font-size: 13px;
      }

      /* modal */
      .modal-bg {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(16, 24, 40, 0.45);
        z-index: 200;
        place-items: center;
        backdrop-filter: blur(3px);
      }
      .modal-bg.on {
        display: grid;
      }
      .modal {
        background: var(--surface);
        border-radius: 14px;
        padding: 28px;
        width: 90%;
        max-width: 440px;
        box-shadow: 0 20px 60px rgba(16, 24, 40, 0.18);
        animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .modal h3 {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 14px;
      }
      .modal textarea {
        width: 100%;
        min-height: 100px;
        resize: vertical;
        border: 1.5px solid var(--border);
        border-radius: 9px;
        padding: 10px 12px;
        font-family: inherit;
        font-size: 13.5px;
        color: var(--ink);
        outline: none;
        line-height: 1.6;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }
      .modal textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
      }
      .modal-acts {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 14px;
      }
      .btn {
        padding: 8px 18px;
        border-radius: 8px;
        font-family: inherit;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: 1.5px solid var(--border);
        background: var(--bg);
        color: var(--ink2);
        transition: all 0.15s;
      }
      .btn:hover {
        background: var(--border);
      }
      .btn.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }
      .btn.primary:hover {
        background: #4338ca;
        border-color: #4338ca;
      }

      /* toast */
      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: var(--ink);
        color: #fff;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 500;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 400;
        white-space: nowrap;
      }
      .toast.on {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: 0;
          top: var(--top);
          bottom: 0;
          z-index: 90;
          width: var(--nav) !important;
          transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .sidebar.closed {
          transform: translateX(-100%);
          border-right-color: var(--border) !important;
        }
        .main {
          padding: 20px 16px;
        }
        .sync-btn span {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-logo">
        <button class="hbtn open" id="hbtn" aria-label="Toggle sidebar">
          <div class="hicon"><span></span><span></span><span></span></div>
        </button>
        <div class="logo-icon">
          <svg viewBox="0 0 20 20">
            <rect x="3" y="3" width="14" height="2.5" rx="1.25" />
            <rect x="3" y="7.5" width="10" height="2.5" rx="1.25" />
            <rect x="3" y="12" width="12" height="2.5" rx="1.25" />
            <rect
              x="3"
              y="16.5"
              width="7"
              height="2.5"
              rx="1.25"
              opacity=".6"
            />
          </svg>
        </div>
        <span class="logo-name" style="margin-left: 10px"
          >Context<span>Note</span></span
        >
      </div>
      <div class="search-wrap">
        <div class="search-box">
          <svg viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input
            type="text"
            id="search"
            placeholder="Search notes‚Ä¶"
            autocomplete="off"
          />
          <button class="s-clear" id="sClear">√ó</button>
        </div>
      </div>

      <div class="sync-wrap">
        <button class="sync-btn" id="syncBtn">
          <svg viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          <span>Cloud Sync</span>
        </button>
        <div class="sync-menu" id="syncMenu">
          <div id="userStatus">Checking auth‚Ä¶</div>
          <div class="sync-div"></div>
          <div class="sync-item" onclick="location.href = '/login'">
            üîë Login with Google
          </div>
          <div class="sync-div"></div>
          <div class="sync-item" onclick="pushToCloud()">
            ‚¨Ü Upload Local Data
          </div>
          <div class="sync-item" onclick="pullFromCloud()">‚¨á Download Data</div>
        </div>
      </div>
    </header>

    <div class="overlay" id="overlay"></div>

    <div class="app-body">
      <nav class="sidebar" id="sidebar">
        <div class="sidebar-hd">
          <span class="sidebar-label">Sources</span>
          <div class="sidebar-meta" id="sideMeta">Loading‚Ä¶</div>
        </div>
        <div class="sidebar-scroll" id="sideNav"></div>
      </nav>

      <main class="main" id="main">
        <div id="skeleton">
          <div
            class="skel"
            style="height: 26px; width: 160px; margin-bottom: 8px"
          ></div>
          <div
            class="skel"
            style="height: 16px; width: 100px; margin-bottom: 28px"
          ></div>
          <div style="margin-bottom: 36px">
            <div
              class="skel"
              style="height: 28px; width: 200px; margin-bottom: 14px"
            ></div>
            <div style="display: flex; gap: 14px">
              <div class="skel" style="min-width: 280px; height: 150px"></div>
              <div class="skel" style="min-width: 280px; height: 150px"></div>
              <div class="skel" style="min-width: 280px; height: 150px"></div>
            </div>
          </div>
          <div>
            <div
              class="skel"
              style="height: 28px; width: 180px; margin-bottom: 14px"
            ></div>
            <div style="display: flex; gap: 14px">
              <div class="skel" style="min-width: 280px; height: 150px"></div>
              <div class="skel" style="min-width: 280px; height: 150px"></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div class="modal-bg" id="modal">
      <div class="modal">
        <h3>Edit Note</h3>
        <textarea id="editTA" rows="5" placeholder="Note content‚Ä¶"></textarea>
        <div class="modal-acts">
          <button class="btn" id="cancelEdit">Cancel</button>
          <button class="btn primary" id="saveEdit">Save</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const $ = (id) => document.getElementById(id);
      const hbtn = $("hbtn"),
        sidebar = $("sidebar"),
        overlay = $("overlay");
      const sideNav = $("sideNav"),
        sideMeta = $("sideMeta"),
        main = $("main");
      const search = $("search"),
        sClear = $("sClear");
      const syncBtn = $("syncBtn"),
        syncMenu = $("syncMenu");
      const modal = $("modal"),
        editTA = $("editTA"),
        toastEl = $("toast");
      let editId = null,
        toastT = null,
        allData = [];

      /* toast */
      const toast = (msg, ms = 2600) => {
        toastEl.textContent = msg;
        toastEl.classList.add("on");
        clearTimeout(toastT);
        toastT = setTimeout(() => toastEl.classList.remove("on"), ms);
      };

      /* sidebar toggle */
      const mobile = () => window.innerWidth <= 768;
      const openSide = () => {
        sidebar.classList.remove("closed");
        hbtn.classList.add("open");
        if (mobile()) overlay.classList.add("on");
      };
      const closeSide = () => {
        sidebar.classList.add("closed");
        hbtn.classList.remove("open");
        overlay.classList.remove("on");
      };
      hbtn.addEventListener("click", () =>
        sidebar.classList.contains("closed") ? openSide() : closeSide(),
      );
      overlay.addEventListener("click", closeSide);

      /* sync dropdown */
      syncBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        syncMenu.classList.toggle("on");
      });
      document.addEventListener("click", (e) => {
        if (!syncMenu.contains(e.target) && e.target !== syncBtn)
          syncMenu.classList.remove("on");
      });
      async function pushToCloud() {
        syncMenu.classList.remove("on");
        toast("Uploading‚Ä¶");
        try {
          const r = await fetch("/api/sync/push", { method: "POST" });
          toast(r.ok ? "Uploaded ‚úì" : "Upload failed");
        } catch {
          toast("Network error");
        }
      }
      async function pullFromCloud() {
        syncMenu.classList.remove("on");
        toast("Downloading‚Ä¶");
        try {
          const r = await fetch("/api/sync/pull", { method: "POST" });
          if (r.ok) {
            toast("Downloaded ‚úì");
            load();
          } else toast("Download failed");
        } catch {
          toast("Network error");
        }
      }

      /* escape html */
      const esc = (s) =>
        String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      /* card html */
      const cardHTML = (n, domain) => {
        const body = n.content || "",
          title = body.length > 55 ? body.slice(0, 55) + "‚Ä¶" : body;
        const sel = n.selection || n.text_selection || "";
        return `<div class="card" data-id="${n.id}" data-t="${esc(body.toLowerCase())}">
      <div class="card-actions">
        <button class="act edit" title="Edit" onclick="openEdit(${n.id},this.closest('.card').querySelector('.c-body').textContent.trim())">
          <svg viewBox="0 0 24 24" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="act del" title="Delete" onclick="del(${n.id},this.closest('.card'))">
          <svg viewBox="0 0 24 24" style="width:13px;height:13px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
        </button>
      </div>
      <div class="c-title">${esc(title)}</div>
      ${sel ? `<div class="c-hi">"${esc(sel)}"</div>` : ""}
      <div class="c-body">${esc(body)}</div>
      <div class="c-tags"><span class="tag">${esc(domain.slice(0, 22))}</span></div>
    </div>`;
      };

      /* render */
      function render(data) {
        $("skeleton")?.remove();
        const total = data.reduce((s, w) => s + w.notes.length, 0);
        sideMeta.textContent = `${data.length} site${data.length !== 1 ? "s" : ""} ¬∑ ${total} notes`;
        sideNav.innerHTML = data.length
          ? data
              .map(
                (s, i) =>
                  `<a class="nav-a${i === 0 ? " on" : ""}" href="#s${i}" data-t="s${i}"><div class="dot"></div><span class="nav-d" title="${esc(s.domain)}">${esc(s.domain)}</span><span class="badge">${s.notes.length}</span></a>`,
              )
              .join("")
          : '<p style="padding:12px;font-size:13px;color:var(--muted)">No sources yet.</p>';

        if (!data.length) {
          main.innerHTML = `<div class="empty"><div class="empty-icon">üìù</div><h3>No notes yet</h3><p>Use the ContextNote extension to save notes from any webpage.</p></div>`;
          return;
        }

        main.innerHTML = `
      <div class="main-h">Your Notes</div>
      <div class="main-s"><strong id="nCount">${total}</strong> notes found</div>
      <div class="no-res" id="noRes"><h3>No notes match "<span id="noResQ"></span>"</h3><p>Try a different search term.</p></div>
      ${data
        .map(
          (site, i) => `
        <div class="section" id="s${i}" data-domain="${esc(site.domain)}">
          <div class="sec-hd">
            <div class="globe"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg></div>
            <span class="sec-domain">${esc(site.domain)}</span>
            <a href="${esc(site.url)}" target="_blank" rel="noopener" class="sec-link">
              <svg viewBox="0 0 24 24" style="width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
              Visit page
            </a>
            <span class="sec-count">${site.notes.length} note${site.notes.length !== 1 ? "s" : ""}</span>
          </div>
          <div class="grid">${site.notes.map((n) => cardHTML(n, site.domain)).join("")}</div>
          ${i < data.length - 1 ? '<div class="divider"></div>' : ""}
        </div>`,
        )
        .join("")}`;

        bindNav();
        bindSearch();
      }

      /* navigation */
      function bindNav() {
        const navAs = document.querySelectorAll(".nav-a[data-t]"),
          secs = document.querySelectorAll(".section");
        navAs.forEach((a) =>
          a.addEventListener("click", (e) => {
            e.preventDefault();
            document
              .getElementById(a.dataset.t)
              ?.scrollIntoView({ behavior: "smooth", block: "start" });
            navAs.forEach((n) => n.classList.remove("on"));
            a.classList.add("on");
            if (mobile()) closeSide();
          }),
        );
        main.addEventListener("scroll", () => {
          let cur = "";
          secs.forEach((s) => {
            if (main.scrollTop + 100 >= s.offsetTop) cur = s.id;
          });
          if (cur)
            navAs.forEach((a) => a.classList.toggle("on", a.dataset.t === cur));
        });
      }

      /* search */
      function bindSearch() {
        search.addEventListener("input", runSearch);
        sClear.addEventListener("click", () => {
          search.value = "";
          runSearch();
          search.focus();
        });
      }
      function runSearch() {
        const q = search.value.trim().toLowerCase();
        sClear.classList.toggle("on", q.length > 0);
        const secs = document.querySelectorAll(".section");
        let vis = 0;
        secs.forEach((s) => {
          let sv = 0;
          s.querySelectorAll(".card").forEach((c) => {
            const m = !q || (c.dataset.t || "").includes(q);
            c.style.display = m ? "" : "none";
            if (m) sv++;
          });
          s.style.display = sv > 0 ? "" : "none";
          vis += sv;
        });
        $("noRes")?.classList.toggle("on", vis === 0 && q.length > 0);
        const qEl = $("noResQ");
        if (qEl) qEl.textContent = q;
        const nEl = $("nCount");
        if (nEl)
          nEl.textContent = q
            ? vis
            : allData.reduce((s, w) => s + w.notes.length, 0);
      }

      /* delete */
      async function del(id, el) {
        if (!confirm("Delete this note?")) return;
        try {
          const r = await fetch(`/api/notes/${id}`, { method: "DELETE" });
          if (r.ok) {
            el.style.cssText =
              "transition:opacity .3s,transform .3s;opacity:0;transform:scale(.92)";
            setTimeout(() => {
              el.remove();
              toast("Note deleted");
            }, 300);
          } else toast("Failed to delete");
        } catch {
          toast("Network error");
        }
      }

      /* edit */
      function openEdit(id, content) {
        editId = id;
        editTA.value = content;
        modal.classList.add("on");
        setTimeout(() => editTA.focus(), 50);
      }
      function closeEdit() {
        modal.classList.remove("on");
        editId = null;
      }
      $("cancelEdit").addEventListener("click", closeEdit);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeEdit();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("on")) closeEdit();
      });
      $("saveEdit").addEventListener("click", async () => {
        const val = editTA.value.trim();
        if (!val) {
          toast("Note cannot be empty");
          return;
        }
        try {
          const r = await fetch(`/api/notes/${editId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: val }),
          });
          if (r.ok) {
            const c = document.querySelector(`.card[data-id="${editId}"]`);
            if (c) {
              c.querySelector(".c-title").textContent =
                val.length > 55 ? val.slice(0, 55) + "‚Ä¶" : val;
              c.querySelector(".c-body").textContent = val;
              c.dataset.t = val.toLowerCase();
            }
            closeEdit();
            toast("Note updated ‚úì");
          } else toast("Failed to save");
        } catch {
          toast("Network error");
        }
      });

      /* load */
      async function load() {
        try {
          const r = await fetch("/api/notes");
          if (r.status === 401) {
            location.href = "/login";
            return;
          }
          allData = await r.json();
          render(allData);
          fetch("/api/me")
            .then((r) => (r.ok ? r.json() : null))
            .then((d) => {
              const el = $("userStatus");
              if (el)
                el.textContent = d
                  ? "‚úì Signed in as " + (d.email || d.name || "User")
                  : "Not signed in";
            })
            .catch(() => {});
        } catch {
          $("skeleton")?.remove();
          main.innerHTML = `<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><h3>Could not load notes</h3><p>Make sure the server is running.</p></div>`;
        }
      }
      window.addEventListener("load", load);
    </script>
  </body>
</html>
